
```bash
dtc -O dtb -o aicarboard_as_gpio.dtbo aicarboard_as_gpio.dts 
sudo cp aicarboard_as_gpio.dtbo /boot
sudo /opt/nvidia/jetson-io/jetson-io.py
```

```bash
sudo apt update
sudo apt install python3 python3-pip -y
sudo pip install --upgrade Jetson.GPIO
```

```bash
sudo usermod -a -G gpio $USER
```

```bash
sudo reboot
```

### Tegra ピン制御ドライバーの改善点
このパッチは、Tegraのピン制御（pinctrl）ドライバーがGPIOピンの多重化を扱う方法を大幅に改善します。
Tegraシステム上のピンが、汎用入出力（GPIO）機能と、I2CやSPIといった様々な特殊機能の間で共有されることが多いため、ピンがモードを切り替える際の適切な状態管理を確実にします。
以前は、あるピンがGPIOとして要求されると、そのピンがGPIOとして動作するか特殊機能として動作するかを制御するsfselビットが無条件でクリアされ、ピンはGPIOモードに強制されていました。
逆に、GPIOが解放されると、sfselビットは常に設定され、ピンは特殊機能モードに強制されていました。このアプローチでは、ピンが元々別の特殊機能のために構成されていた場合、意図しない動作につながる可能性がありました。
改善されたドライバーは、GPIOが要求された際にsfselビットの元の状態を記憶するようになりました。GPIOが解放されるとき、sfselビットを任意に設定する代わりに、その元の状態に復元します。これにより、ピンの構成がGPIO使用前の状態に戻ることが保証され、それを使用していた可能性のある他の特殊機能との競合が防止されます。
改善されたドライバーは、GPIOが要求された際にsfselビットの元の状態を記憶するようになりました。GPIOが解放されるとき、sfselビットを任意に設定する代わりに、その元の状態に復元します。これにより、ピンの構成がGPIO使用前の状態に戻ることが保証され、それを使用していた可能性のある他の特殊機能との競合が防止されます。

### 設定の追跡機能の追加
このパッチでは、pingroup_configs配列という新しいメカニズムが導入されました。この配列により、ドライバーはグループごとの状態情報を保存できるようになります。基本的に、これは異なるピンのグループの設定を追跡するための構造化された方法を提供します。この追加は、ドライバーを将来の機能強化に対してより柔軟にするための重要な一歩であり、より複雑なピン管理戦略の基盤を築き、新しい機能の統合を容易にします。

### 不必要な変更の回避
sfselビットを記憶し、条件付きで復元することにより、ドライバーは不必要なレジスタ書き込みを回避するようになりました。ピンのsfsel状態がすでに望ましい状態である場合、レジスタに書き込む必要はありません。この小さくても重要な変更は、冗長な操作を減らすことで効率を向上させ、不必要なレジスタ操作から生じる可能性のある副作用を軽減するのに役立ちます。

要するに、これらの変更により、Tegraのpinctrlドライバーは共有ピンの扱いにおいてより堅牢かつインテリジェントになり、スムーズな移行を保証し、GPIOと他の特殊機能間の意図しない相互作用を防ぎます。

#FaBo Inc.
relese date
2025/07/13
